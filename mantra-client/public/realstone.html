<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mantra - Client</title>
  <link rel="stylesheet" href="/mantra.css">
  <script type="module" src="/mantra.js"></script>
  <script type="module" src="/realstone.js"></script>
  <script type="module" src="/realDemo.js"></script>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
    }

    #main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 20px 0;
    }

    #contraption-interface {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      position: absolute;
      right: 20px;
      top: 140px;

    }

    #save-contraption-form {

      display: none;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    #display-contraption {
      text-align: center;
    }

    #run-contraption-form {
      display: none;
    }

    #save-contraption-form label {
      font-weight: bold;
    }

    #save-contraption-form input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #save-contraption-form button {
      padding: 10px 15px;
      background-color: #0056b3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #save-contraption-form button:hover {
      background-color: #003d82;
    }

    h1 {
      color: #333;
      position: absolute;
      right: 20px;
      top: 60px;

    }

    h3 {
      color: #555;
    }

    textarea {
      position: absolute;
      top: 50px;
      left: 0;
      width: 400px;
      height: 800px;
      font-family: 'Courier New', monospace;
      /* Monospace font */
      background-color: #282c34;
      /* Dark background */
      color: #abb2bf;
      /* Light text */
      padding: 10px;
      /* Padding inside textarea */
      border: 1px solid #abb2bf;
      /* Optional border */
      width: 100%;
      /* Width of the editor */
      height: 300px;
      /* Height of the editor */
      line-height: 1.5;
      /* Line height for better readability */
      tab-size: 4;
      /* Set tab size for better code formatting */
      white-space: pre;
      /* Preserve whitespace and formatting */
      width: 600px;
      height: 1000px;

    }

    select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      color: #0056b3;
    }
  </style>
  <script>
    let etherspaceHost = 'http://192.168.1.80:8889/api/v1';
    //etherspaceHost = 'https://etherspace.ayyo.gg/api/v1';
    let etherspaceEndpoint = etherspaceHost + '';

    async function getContraption(contraptionId) {
      const contraptionNameDisplay = document.getElementById('contraption-name-display');

      // Implement GET request to fetch contraption
      const response = await fetch(`${etherspaceEndpoint}/contraption/${contraptionId}`);
      const data = await response.json();

      if (data) {
        contraptionNameDisplay.textContent = data.name; // Update display with fetched name
      } else {
        contraptionNameDisplay.textContent = 'Could not find: ' + contraptionId;
      }

      let displayContraption = document.getElementById('display-contraption');
      if (displayContraption) {
        displayContraption.style.display = 'block';
      }

      // Set contraption-code textarea value to fetched code
      let contraptionCode = document.getElementById('contraption-code');
      if (contraptionCode) {
        contraptionCode.value = data.code;
      }

      // Update input contraption-name with new name
      let contraptionName = document.getElementById('contraption-name');
      if (contraptionName) {
        contraptionName.value = data.name;
      }

      // Update the select dropdown
      updateSelectDropdown(data.name);

      // Clear all PARTS from Mantra
      if (game.systems.realstone) {
        game.systems.realstone.clearAllParts();
      }

      // For now autorun
      let autoRunCode = true;
      if (autoRunCode) {
        setTimeout(() => {
          // runContraption(data.code);
          runContraptionModule(data.code);
        }, 200);
      }
    }
    window.getContraption = getContraption;

    async function runContraptionModule(code) {
      try {

        console.log('About to run code', code)

        // Create a new blob with the fetched code
        const blob = new Blob([code], { type: 'application/javascript' });

        // Create a URL for the blob
        const url = URL.createObjectURL(blob);

        // Dynamically import the blob as a module
        const module = await import(url);

        // Assuming the module exports a function named 'default'
        const contraption = module.default();

        // Assuming the system name is declared globally in the code
        let systemName = module.default.name;
        window[systemName] = contraption;

        // Set the contraption to the RealStone system
        if (window[systemName]) {
          game.systems.realstone.setContraption(window[systemName]);
        }

        if (contraption.start) {
          // contraption.start();
        }

        // Clean up by revoking the blob URL
        URL.revokeObjectURL(url);

        console.log('Contraption loaded and executed');
      } catch (error) {
        console.error('Error running contraption:', error);
      }
    }

    function updateSelectDropdown(name) {
      let contraptionSelect = document.getElementById('contraption-select');
      if (contraptionSelect) {
        contraptionSelect.value = name;
      } else {
        // Add the new option to the select dropdown
        let selectElement = document.createElement('select');
        selectElement.id = 'contraption-select';
        let optionElement = document.createElement('option');
        optionElement.value = name; // Assuming each contraption has a name
        optionElement.textContent = name;
        selectElement.appendChild(optionElement);
        selectElement.value = name;
      }
    }

    document.addEventListener('DOMContentLoaded', async function () {
      const form = document.getElementById('save-contraption-form');
      const contraptionNameDisplay = document.getElementById('contraption-name-display');

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        const contraptionName = document.getElementById('contraption-name').value;
        // Implement the POST request to save the contraption
        saveContraption(contraptionName);
      });

      const runContraptionForm = document.getElementById('run-contraption-form');
      runContraptionForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const contraptionCode = document.getElementById('contraption-code').value;
        runContraption(contraptionCode);
      });

      // Define your endpoint and user ID
      const userId = 'Marak'; // Replace with the actual user ID

      // Function to fetch contraptions for a given user
      async function fetchContraptionsForUser(userId) {
        try {
          const response = await fetch(`${etherspaceEndpoint}/contraptions/${userId}`);
          const contraptions = await response.json();
          // Call function to render dropdown with fetched contraptions
          renderDropdown(contraptions);
        } catch (error) {
          console.error('Error fetching contraptions:', error);
          // Handle any errors, such as by displaying a message to the user
        }
      }

      // Function to render dropdown select with contraptions
      function renderDropdown(contraptions) {
        const selectElement = document.createElement('select');
        selectElement.id = 'contraption-select';
        contraptions.forEach(contraption => {
          const optionElement = document.createElement('option');
          optionElement.value = contraption.name; // Assuming each contraption has an ID
          optionElement.textContent = contraption.name; // And a name
          selectElement.appendChild(optionElement);
        });

        // get display-contraption div
        let displayContraption = document.getElementById('display-contraption');
        // Append the select element to the body or another element in your page
        displayContraption.appendChild(selectElement);

        // Optionally, add an event listener for when the user selects a contraption
        selectElement.addEventListener('change', (event) => {
          const selectedContraptionId = event.target.value;
          console.log(`User selected contraption ID: ${selectedContraptionId}`);
          // unload contraption
          // load contraption
          getContraption(selectedContraptionId);
          // Additional code to handle the selection
        });
      }

      // Call the function with the user ID
      await fetchContraptionsForUser(userId);

      let contraptionName = 'button-relay-light';
      contraptionName = 'rover-light';
      // contraptionName = 'all-examples-composite';
      // Could auto-load a contraption at start
      // for now, we will load allExamples from memory
      await getContraption(contraptionName);

      // Set the contraption to the RealStone system
      //let allExamples = RS.allExamples();
      //game.systems.realstone.setContraption(allExamples);


      // getContraption('button-actuator-light');
      //getContraption('button-amplify-wire-light');
      async function saveContraption(name) {

        // get the code from the textarea
        let contraptionCode = document.getElementById('contraption-code').value;
        // Assuming roverLightSystem is a variable that holds the contraption code
        const payload = {
          name: name,
          code: contraptionCode || '' // This should be defined in your scope
        };

        try {
          const response = await fetch(`${etherspaceEndpoint}/api/v1/contraption/${name}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          const data = await response.json();

          if (response.ok) {
            contraptionNameDisplay.textContent = `Saved: ${data.name}`;
          } else {
            contraptionNameDisplay.textContent = `Error saving contraption: ${data.message}`;
          }
        } catch (error) {
          contraptionNameDisplay.textContent = `Network error: ${error.message}`;
        }

        let displayContraption = document.getElementById('display-contraption');
        if (displayContraption) {
          displayContraption.style.display = 'block';
        }
      }

    });

  </script>
</head>

<body>

  <div id="main-container">
    <header>
      <h1>RealStone Contraption Viewer</h1>
    </header>

    <section id="contraption-interface">
      <div id="display-contraption">
        <h3>Contraption Name: <span id="contraption-name-display"></span></h3>
      </div>

      <form id="save-contraption-form">
        <label for="contraption-name">Contraption Name:</label>
        <input type="text" id="contraption-name" placeholder="Enter contraption name" required>
        <button type="submit">Save Contraption</button>
      </form>

      <form id="run-contraption-form">
        <button type="submit">Run Contraption</button>
      </form>

    </section>
    <textarea id="contraption-code" rows="10" cols="50" placeholder="Enter contraption code here"></textarea>

  </div>

  <!--
  <div id="contraption-interface">
    <div id="display-contraption">
      <h3>Contraption Name: <span id="contraption-name-display"></span></h3>
    </div>
    <form id="save-contraption-form">
      <input type="text" id="contraption-name" placeholder="Enter contraption name" value="rover-light" required>
      <button type="submit">Save Contraption</button>
    </form>
    <form id="run-contraption-form">
      <button type="submit">Run Contraption</button>
      <textarea id="contraption-code" rows="10" cols="50" placeholder="Enter contraption code here"></textarea>
    </form>
  </div>
  -->

</body>

</html>