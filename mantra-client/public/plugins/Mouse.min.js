(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}(g.PLUGINS || (g.PLUGINS = {})).Mouse = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,_toPropertyKey(i.key),i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,n){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var inputsBound=!1,Mouse=exports.default=function(){function t(e){_classCallCheck(this,t),this.id=t.id,this.mousePosition={x:0,y:0},this.disableContextMenu=!0,this.isDragging=!1,this.dragStartPosition={x:0,y:0},this.inputsBound=!1,this.mouseButtons={LEFT:null,RIGHT:null,MIDDLE:null},this.buttonMappings={LEFT:0,MIDDLE:1,RIGHT:2},this.tagAllowsDefaultEvent=["BUTTON","INPUT","TEXTAREA","SELECT","CODE","PRE","A","H3"],this.tagPreventsGameEvent=["SELECT","BUTTON","LABEL","INPUT"],this.disallowedPointerDownTags=["H3"],this.disallowedPointerDownClasses=["gui-container"],this.activeTouches={},this.firstTouchId=null,this.secondTouchId=null,this.endedFirstTouch=!1,this.endedSecondTouch=!1,this.boundHandleMouseMove=this.handleMouseMove.bind(this),this.boundHandleMouseDown=this.handleMouseDown.bind(this),this.boundHandleMouseUp=this.handleMouseUp.bind(this),this.boundHandleMouseOut=this.handleMouseOut.bind(this),this.boundHandleMouseOver=this.handleMouseOver.bind(this),this.boundHandlePointerDown=this.handlePointerDown.bind(this),this.boundHandlePointerMove=this.handlePointerMove.bind(this),this.boundHandlePointerUp=this.handlePointerUp.bind(this),this.boundHandleWindowBlur=this.handleWindowBlur.bind(this),this.boundHandleMouseLeave=this.handleMouseLeave.bind(this)}return _createClass(t,[{key:"init",value:function(e){this.game=e,this.id=t.id,e.config.mouseMovementButton="LEFT",e.config.mouseActionButton="RIGHT",this.bindInputControls(),this.game.systemsManager.addSystem(this.id,this)}},{key:"setButtonMapping",value:function(t,e){this.buttonMappings.hasOwnProperty(t)?this.buttonMappings[t]=e:console.error("Invalid button: ".concat(t))}},{key:"getButtonMapping",value:function(t){return this.buttonMappings[t]||null}},{key:"createMouseContext",value:function(t){for(var e=t.clientX,n=t.clientY,i=t.target instanceof HTMLCanvasElement?t.target:null,o=i?this.getCanvasPosition(i,e,n):null,s=this.getWorldPosition(e,n),u=t.target,a=null;u&&u!==document.body;){if(u.getAttribute&&u.getAttribute("mantra-id")){a=u.getAttribute("mantra-id");break}u=u.parentNode}this.updateSelectedEntity(a,t.target);var d={mousePosition:{x:e,y:n},canvasPosition:o,worldPosition:s,event:t,entityId:this.game.selectedEntityId||null,isDragging:this.isDragging,dragStartPosition:this.dragStartPosition,buttons:this.mouseButtons,firstTouchId:this.firstTouchId,secondTouchId:this.secondTouchId,activeTouchCount:Object.keys(this.activeTouches).length,activeTouches:this.activeTouches,target:null,owner:null};return this.game.data&&this.game.data.ents&&this.game.data.ents._&&(d.target=this.game.data.ents._[this.game.selectedEntityId]||null,d.owner=this.game.data.ents._[this.game.currentPlayerId]||null),d.position=d.worldPosition,d.x=d.position.x,d.y=d.position.y,d}},{key:"getCanvasPosition",value:function(t,e,n){var i=t.getBoundingClientRect();return{x:e-i.left,y:n-i.top}}},{key:"getWorldPosition",value:function(t,e){var n=this.game.data.camera,i=n.offsetX,o=n.offsetY,s=n.currentZoom,u=n.position;return{x:(t-window.innerWidth/2+i)/s+u.x,y:(e-window.innerHeight/2+o)/s+u.y}}},{key:"updateSelectedEntity",value:function(t,e){t?this.game.selectedEntityId=t:"BODY"!==e.tagName&&(this.game.selectedEntityId=null)}},{key:"handleWindowBlur",value:function(){this.isDragging=!1,this.activeTouches={},this.firstTouchId=null,this.secondTouchId=null,this.endedFirstTouch=!1,this.endedSecondTouch=!1,this.mouseButtons={LEFT:null,RIGHT:null,MIDDLE:null},this.sendMouseData()}},{key:"handleMouseLeave",value:function(){this.isDragging=!1,this.activeTouches={},this.firstTouchId=null,this.secondTouchId=null,this.endedFirstTouch=!1,this.endedSecondTouch=!1,this.mouseButtons={LEFT:null,RIGHT:null,MIDDLE:null},this.sendMouseData()}},{key:"handleMouseMove",value:function(t){this.game,t.target;if(this.firstTouchId&&(t.pointerId!==this.firstTouchId||this.secondTouchId)||(this.mousePosition={x:t.clientX,y:t.clientY}),t.target instanceof HTMLCanvasElement){var e=t.target.getBoundingClientRect();this.canvasPosition={x:t.clientX-e.left,y:t.clientY-e.top}}else this.canvasPosition=null;if(this.isDragging){var n=this.mousePosition.x-this.dragStartPosition.x,i=this.mousePosition.y-this.dragStartPosition.y;this.dx=n,this.dy=i,this.dragStartPosition={x:this.mousePosition.x,y:this.mousePosition.y}}if(this.sendMouseData(),this.game.data&&this.game.data.ents&&this.game.data.ents._){var o=this.game.data.ents._[this.game.selectedEntityId];if(o&&o.pointermove){o.pointermove(o,t)}}var s=this.createMouseContext(t);s.x=s.position.x,s.y=s.position.y,this.game.emit("pointerMove",s,t)}},{key:"updateMouseButtons",value:function(t,e){var n;switch(t.button){case this.buttonMappings.LEFT:n="LEFT";break;case this.buttonMappings.MIDDLE:n="MIDDLE";break;case this.buttonMappings.RIGHT:n="RIGHT";break;default:return void console.error("Unknown button index: ".concat(t.button))}n&&(this.mouseButtons[n]=e)}},{key:"handleMouseDown",value:function(t){var e=t.target,n=(this.game,!1);if(this.updateMouseButtons(t,!0),t.button===this.buttonMappings.MIDDLE){if(this.disallowedPointerDownTags.includes(e.tagName))return;if(this.disallowedPointerDownClasses.some(function(t){return e.classList.contains(t)}))return;if(this.firstTouchId&&this.secondTouchId)return void t.preventDefault();this.isDragging=!0,this.dragStartPosition={x:t.clientX,y:t.clientY},n=!!this.tagAllowsDefaultEvent.includes(e.tagName)}this.tagPreventsGameEvent.includes(e.tagName)&&(n=!0);var i=this.createMouseContext(t);i.target&&i.target.pointerdown&&i.target.pointerdown(i,t),n||(this.game.emit("pointerDown",i,t),window.parent!==window&&window.parent.postMessage({type:"pointerDown",context:{entityId:this.game.selectedEntityId,position:i.position,buttons:this.mouseButtons}},"*"),this.sendMouseData(t))}},{key:"handleMouseUp",value:function(t){this.updateMouseButtons(t,!1),t.button===this.buttonMappings.MIDDLE&&(this.isDragging=!1,t.preventDefault());var e=this.game.data.ents._[this.game.selectedEntityId];if(e&&e.pointerup){e.pointerup(e,t)}var n=this.createMouseContext(t);n.endedFirstTouch=this.endedFirstTouch,n.endedSecondTouch=this.endedSecondTouch,this.game.emit("pointerUp",n,t),this.sendMouseData(t)}},{key:"handleMouseOut",value:function(t){var e=t.target;this.game;if(e&&e.getAttribute){var n=e.getAttribute("mantra-id");if(n&&(this.game.selectedEntityId=n,this.game.data&&this.game.data.ents)){var i=this.game.data.ents._[n];if(i&&i.pointerout){i.pointerout(i,t)}}}this.game.emit("pointerOut",t)}},{key:"handleMouseOver",value:function(t){t.target;this.game.emit("pointerOver",this.game.selectedEntityId||{},t),this.sendMouseData(t)}},{key:"handlePointerDown",value:function(t){this.activeTouches[t.pointerId]={x:t.clientX,y:t.clientY},null===this.firstTouchId?this.firstTouchId=t.pointerId:null===this.secondTouchId&&(this.secondTouchId=t.pointerId),this.handleMouseDown(t)}},{key:"handlePointerMove",value:function(t){this.activeTouches[t.pointerId]&&(this.activeTouches[t.pointerId]={x:t.clientX,y:t.clientY},t.pointerId===this.firstTouchId||(t.pointerId,this.secondTouchId)),this.handleMouseMove(t)}},{key:"handlePointerUp",value:function(t){this.endedFirstTouch=t.pointerId===this.firstTouchId,this.endedSecondTouch=t.pointerId===this.secondTouchId,delete this.activeTouches[t.pointerId],t.pointerId===this.firstTouchId?this.firstTouchId=null:t.pointerId===this.secondTouchId&&(this.secondTouchId=null),this.handleMouseUp(t)}},{key:"sendMouseData",value:function(t){var e={position:this.mousePosition,canvasPosition:this.canvasPosition,buttons:this.mouseButtons,isDragging:this.isDragging,dragStartPosition:this.dragStartPosition,dx:this.dx,dy:this.dy,event:t,worldPosition:{x:(this.mousePosition.x-window.innerWidth/2+this.game.data.camera.offsetX)/this.game.data.camera.currentZoom+this.game.data.camera.position.x,y:(this.mousePosition.y-window.innerHeight/2+this.game.data.camera.offsetY)/this.game.data.camera.currentZoom+this.game.data.camera.position.y}};this.game.data.mouse=e,this.game.communicationClient&&this.game.communicationClient.sendMessage("player_input",{mouse:e})}},{key:"preventMultiTouchDefault",value:function(t){t.touches.length>1&&t.preventDefault()}},{key:"preventGestureDefault",value:function(t){t.preventDefault()}},{key:"bindInputControls",value:function(){var t=this;if(!0!==inputsBound){inputsBound=!0,this.game.isTouchDevice()?(document.addEventListener("pointerover",this.boundHandleMouseOver),document.addEventListener("pointerout",this.boundHandleMouseOut),document.addEventListener("pointermove",this.boundHandlePointerMove),document.addEventListener("pointerdown",this.boundHandlePointerDown),document.addEventListener("pointerup",this.boundHandlePointerUp),document.addEventListener("touchstart",this.preventMultiTouchDefault,{passive:!1}),document.addEventListener("touchmove",this.preventMultiTouchDefault,{passive:!1}),document.addEventListener("gesturestart",this.preventGestureDefault,{passive:!1})):(document.addEventListener("mouseover",this.boundHandleMouseOver),document.addEventListener("mouseout",this.boundHandleMouseOut),document.addEventListener("mousemove",this.boundHandleMouseMove),document.addEventListener("mousedown",this.boundHandleMouseDown),document.addEventListener("mouseup",this.boundHandleMouseUp)),window.addEventListener("blur",this.boundHandleWindowBlur),document.body.addEventListener("mouseleave",this.boundHandleMouseLeave),document.addEventListener("contextmenu",function(e){t.disableContextMenu&&!1!==t.game.config.disableContextMenu&&e.preventDefault()});var e=null;document.addEventListener("touchstart",function(t){2===t.touches.length&&(e=n(t.touches[0],t.touches[1]))},{passive:!1}),document.addEventListener("touchmove",function(t){if(t.touches.length>1){var i=n(t.touches[0],t.touches[1]);if(null!==e){var o=1*(i/e);s=o,o=Math.max(.5,Math.min(s,3.5)),e=i}t.preventDefault()}var s},{passive:!1}),document.addEventListener("touchend",function(t){e=null},{passive:!1}),document.addEventListener("gesturestart",function(t){t.preventDefault()},{passive:!1})}function n(t,e){var n=t.pageX-e.pageX,i=t.pageY-e.pageY;return Math.sqrt(n*n+i*i)}}},{key:"unbindAllEvents",value:function(){this.game.isTouchDevice()?(document.removeEventListener("pointerover",this.boundHandleMouseOver),document.removeEventListener("pointerout",this.boundHandleMouseOut),document.removeEventListener("pointermove",this.boundHandlePointerMove),document.removeEventListener("pointerdown",this.boundHandlePointerDown),document.removeEventListener("pointerup",this.boundHandlePointerUp)):(document.removeEventListener("mouseover",this.boundHandleMouseOver),document.removeEventListener("mouseout",this.boundHandleMouseOut),document.removeEventListener("mousemove",this.boundHandleMouseMove),document.removeEventListener("mousedown",this.boundHandleMouseDown),document.removeEventListener("mouseup",this.boundHandleMouseUp)),window.removeEventListener("blur",this.boundHandleWindowBlur),window.removeEventListener("mouseleave",this.boundHandleMouseLeave)}},{key:"unload",value:function(){this.unbindAllEvents()}}]),t}();_defineProperty(Mouse,"id","mouse");

},{}]},{},[1])(1)
});
