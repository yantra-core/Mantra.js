(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}(g.PLUGINS || (g.PLUGINS = {})).Mouse = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var Mouse=exports.default=function(){function e(t){_classCallCheck(this,e),this.id=e.id,this.mousePosition={x:0,y:0},this.disableContextMenu=!0,this.isDragging=!1,this.dragStartPosition={x:0,y:0},this.mouseButtons={LEFT:null,RIGHT:null,MIDDLE:null},this.activeTouches={},this.firstTouchId=null,this.secondTouchId=null,this.endedFirstTouch=!1,this.endedSecondTouch=!1,this.boundHandleMouseMove=this.handleMouseMove.bind(this),this.boundHandleMouseDown=this.handleMouseDown.bind(this),this.boundHandleMouseUp=this.handleMouseUp.bind(this),this.boundHandleMouseOut=this.handleMouseOut.bind(this),this.boundHandleMouseOver=this.handleMouseOver.bind(this),this.boundHandlePointerDown=this.handlePointerDown.bind(this),this.boundHandlePointerMove=this.handlePointerMove.bind(this),this.boundHandlePointerUp=this.handlePointerUp.bind(this)}return _createClass(e,[{key:"init",value:function(t){this.game=t,this.id=e.id,t.config.mouseMovementButton="LEFT",t.config.mouseActionButton="RIGHT",this.bindInputControls(),this.game.systemsManager.addSystem(this.id,this)}},{key:"createMouseContext",value:function(e){var t=e.clientX,i=e.clientY,n=e.target instanceof HTMLCanvasElement?e.target:null,o=null;if(n){var s=n.getBoundingClientRect();o={x:t-s.left,y:i-s.top}}var a={mousePosition:{x:t,y:i},canvasPosition:o,worldPosition:{x:(t-window.innerWidth/2+this.game.data.camera.offsetX)/this.game.data.camera.currentZoom+this.game.data.camera.position.x,y:(i-window.innerHeight/2+this.game.data.camera.offsetY)/this.game.data.camera.currentZoom+this.game.data.camera.position.y},event:e,entityId:this.game.selectedEntityId||null,isDragging:this.isDragging,dragStartPosition:this.dragStartPosition,buttons:this.mouseButtons,firstTouchId:this.firstTouchId,secondTouchId:this.secondTouchId,activeTouchCount:Object.keys(this.activeTouches).length,activeTouches:this.activeTouches};return a.position=a.worldPosition,a}},{key:"handleMouseMove",value:function(e){this.game,e.target;if(this.mousePosition={x:e.clientX,y:e.clientY},e.target instanceof HTMLCanvasElement){var t=e.target.getBoundingClientRect();this.canvasPosition={x:e.clientX-t.left,y:e.clientY-t.top}}else this.canvasPosition=null;if(this.isDragging){var i=this.mousePosition.x-this.dragStartPosition.x,n=this.mousePosition.y-this.dragStartPosition.y;this.dx=i,this.dy=n,this.dragStartPosition={x:this.mousePosition.x,y:this.mousePosition.y}}if(this.sendMouseData(),this.game.data&&this.game.data.ents&&this.game.data.ents._){var o=this.game.data.ents._[this.game.selectedEntityId];if(o&&o.pointermove){o.pointermove(o,e)}}var s=this.createMouseContext(e);s.x=s.position.x,s.y=s.position.y,this.game.emit("pointerMove",s,e)}},{key:"updateMouseButtons",value:function(e,t){if(this.game.isTouchDevice())switch(e.button){case 2:this.mouseButtons.LEFT=t;break;case 1:this.mouseButtons.MIDDLE=t;break;case 0:this.mouseButtons.RIGHT=t}else switch(e.button){case 0:this.mouseButtons.LEFT=t;break;case 1:this.mouseButtons.MIDDLE=t;break;case 2:this.mouseButtons.RIGHT=t}}},{key:"handleMouseDown",value:function(e){var t=e.target;this.game;if(t&&t.getAttribute){var i=t.getAttribute("mantra-id");if(i&&(this.game.selectedEntityId=i,this.game.data&&this.game.data.ents)){var n=this.game.data.ents._[Number(i)];if(n&&n.pointerdown){n.pointerdown(n,e)}}if(!i&&(this.game.selectedEntityId=null,"BODY"!=t.tagName))return void(this.game.selectedEntityId=null)}this.updateMouseButtons(e,!0),1===e.button&&(this.isDragging=!0,this.dragStartPosition={x:e.clientX,y:e.clientY},e.preventDefault());var o=this.createMouseContext(e);this.game.emit("pointerDown",o,e),window.parent!==window&&window.parent.postMessage({type:"pointerDown",context:{entityId:this.game.selectedEntityId,position:o.position,buttons:this.mouseButtons}},"*"),this.sendMouseData(e)}},{key:"handleMouseUp",value:function(e){this.updateMouseButtons(e,!1),1===e.button&&(this.isDragging=!1,e.preventDefault());var t=this.game.data.ents._[this.game.selectedEntityId];if(t&&t.pointerup){t.pointerup(t,e)}var i=this.createMouseContext(e);i.endedFirstTouch=this.endedFirstTouch,i.endedSecondTouch=this.endedSecondTouch,this.game.emit("pointerUp",i,e),this.sendMouseData(e)}},{key:"handleMouseOut",value:function(e){var t=e.target;this.game;if(t&&t.getAttribute){var i=t.getAttribute("mantra-id");if(i&&(this.game.selectedEntityId=i,this.game.data&&this.game.data.ents)){var n=this.game.data.ents._[i];if(n&&n.pointerout){n.pointerout(n,e)}}}this.game.emit("pointerOut",e)}},{key:"handleMouseOver",value:function(e){e.target;this.game.emit("pointerOver",this.game.selectedEntityId||{},e),this.sendMouseData(e)}},{key:"handlePointerDown",value:function(e){this.activeTouches[e.pointerId]={x:e.clientX,y:e.clientY},null===this.firstTouchId?this.firstTouchId=e.pointerId:null===this.secondTouchId&&(this.secondTouchId=e.pointerId),this.handleMouseDown(e)}},{key:"handlePointerMove",value:function(e){this.activeTouches[e.pointerId]&&(this.activeTouches[e.pointerId]={x:e.clientX,y:e.clientY},e.pointerId===this.firstTouchId||(e.pointerId,this.secondTouchId)),this.handleMouseMove(e)}},{key:"handlePointerUp",value:function(e){this.endedFirstTouch=e.pointerId===this.firstTouchId,this.endedSecondTouch=e.pointerId===this.secondTouchId,delete this.activeTouches[e.pointerId],e.pointerId===this.firstTouchId?this.firstTouchId=null:e.pointerId===this.secondTouchId&&(this.secondTouchId=null),this.handleMouseUp(e)}},{key:"sendMouseData",value:function(e){var t={position:this.mousePosition,canvasPosition:this.canvasPosition,buttons:this.mouseButtons,isDragging:this.isDragging,dragStartPosition:this.dragStartPosition,dx:this.dx,dy:this.dy,event:e,worldPosition:{x:(this.mousePosition.x-window.innerWidth/2+this.game.data.camera.offsetX)/this.game.data.camera.currentZoom+this.game.data.camera.position.x,y:(this.mousePosition.y-window.innerHeight/2+this.game.data.camera.offsetY)/this.game.data.camera.currentZoom+this.game.data.camera.position.y}};this.game.data.mouse=t,this.game.communicationClient&&this.game.communicationClient.sendMessage("player_input",{mouse:t})}},{key:"bindInputControls",value:function(){this.game.isTouchDevice()?(document.addEventListener("pointerover",this.boundHandleMouseOver),document.addEventListener("pointerout",this.boundHandleMouseOut),document.addEventListener("pointermove",this.boundHandlePointerMove),document.addEventListener("pointerdown",this.boundHandlePointerDown),document.addEventListener("pointerup",this.boundHandlePointerUp)):(document.addEventListener("mouseover",this.boundHandleMouseOver),document.addEventListener("mouseout",this.boundHandleMouseOut),document.addEventListener("mousemove",this.boundHandleMouseMove),document.addEventListener("mousedown",this.boundHandleMouseDown),document.addEventListener("mouseup",this.boundHandleMouseUp)),this.disableContextMenu&&document.addEventListener("contextmenu",function(e){e.preventDefault()}),document.addEventListener("touchmove",function(e){e.touches.length>1&&e.preventDefault()},{passive:!1})}},{key:"unbindAllEvents",value:function(){this.game.isTouchDevice()?(document.removeEventListener("pointerover",this.boundHandleMouseOver),document.removeEventListener("pointerout",this.boundHandleMouseOut),document.removeEventListener("pointermove",this.boundHandlePointerMove),document.removeEventListener("pointerdown",this.boundHandlePointerDown),document.removeEventListener("pointerup",this.boundHandlePointerUp)):(document.removeEventListener("mouseover",this.boundHandleMouseOver),document.removeEventListener("mouseout",this.boundHandleMouseOut),document.removeEventListener("mousemove",this.boundHandleMouseMove),document.removeEventListener("mousedown",this.boundHandleMouseDown),document.removeEventListener("mouseup",this.boundHandleMouseUp))}},{key:"unload",value:function(){this.unbindAllEvents()}}]),e}();_defineProperty(Mouse,"id","mouse");

},{}]},{},[1])(1)
});
