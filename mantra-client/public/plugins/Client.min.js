(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}(g.PLUGINS || (g.PLUGINS = {})).Client = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _LocalClient=_interopRequireDefault(require("./LocalClient.js")),_WebSocketClient=_interopRequireDefault(require("./WebSocketClient.js")),_defaultAssets=_interopRequireDefault(require("./defaultAssets.js"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,o){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,t||"default");if("object"!==_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var Client=exports.default=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.protobuf,i=void 0!==o&&o,n=t.msgpack,r=void 0!==n&&n,s=t.deltaEncoding,a=void 0===s||s,l=t.deltaCompression,u=void 0!==l&&l;_classCallCheck(this,e),this.id=e.id,this.config={protobuf:i,msgpack:r,deltaEncoding:a,deltaCompression:u},this.started=!1,this.preloading=!1}return _createClass(e,[{key:"init",value:function(e){this.game=e,e.use(new _LocalClient.default),e.use(new _WebSocketClient.default({protobuf:this.config.protobuf,msgpack:this.config.msgpack,deltaCompression:this.config.deltaCompression,deltaEncoding:this.config.deltaEncoding}));var t=e.preloader;if(e.isServer)this.preloading=!1;else{for(var o in e.queuedAssets){var i=e.queuedAssets[o];t.addAsset(i,"image",o)}for(var n in e.queuedAssets={},_defaultAssets.default){var r=_defaultAssets.default[n];"string"!=typeof r?"spritesheet"!==r.type&&"sheet"!==r.type?"model"!==r.type&&"model-fbx"!==r.type||t.addAsset(r.url,"model-fbx",n,r):t.addAsset(r.url,"spritesheet",n,r):t.addAsset(r,"image",n)}this.preloading=!0;var s=this;console.log("Loading Mantra.css file..."),e.loadCSS("/mantra.css",function(e,o){console.log("mantra.css loaded!"),t.loadAll().then(function(){console.log("All assets loaded",t),s.preloading=!1})})}e.systemsManager.addSystem("client",this)}},{key:"start",value:function(e){var t=this;this.preloading?setTimeout(function(){t.start(e)},4):(this.game.getSystem("localClient").start(e),this.started=!0)}},{key:"stop",value:function(){console.log("Client.js plugin stopping game"),this.started=!1,this.game.getSystem("localClient").stop()}},{key:"connect",value:function(e){this.game.getSystem("websocketClient").connect(e)}},{key:"disconnect",value:function(){this.game.getSystem("websocketClient").disconnect()}},{key:"sendMessage",value:function(e,t){this.game.getSystem("localClient").sendMessage(e,t)}}]),e}();_defineProperty(Client,"id","client"),_defineProperty(Client,"removable",!1);

},{"./LocalClient.js":2,"./WebSocketClient.js":3,"./defaultAssets.js":4}],2:[function(require,module,exports){
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!==_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var LocalClient=exports.default=function(){function e(){_classCallCheck(this,e),this.started=!1,this.id=e.id}return _createClass(e,[{key:"init",value:function(e){this.game=e,this.game.isClient=!0,e.localGameLoopRunning=!1,this.game.systemsManager.addSystem("localClient",this)}},{key:"start",value:function(e){this.game;void 0===e&&(e=function(){}),this.game.isOnline=!1;e(null,!0),this.game.emit("start"),this.game.systems.xstate&&this.game.systems.xstate.sendEvent("START"),this.game.localGameLoopRunning=!0,this.game.localGameLoop(this.game),this.game.communicationClient=this}},{key:"stop",value:function(){console.log("Local Client is stopping..."),this.game.localGameLoopRunning=!1}},{key:"sendMessage",value:function(e,t){"player_input"===e&&this.game.emit("entityInput::handleInputs",this.game.currentPlayerId,{controls:t.controls,mouse:t.mouse,actions:t.actions},null)}}]),e}();_defineProperty(LocalClient,"id","client-local");

},{}],3:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _msgpack=require("@msgpack/msgpack"),_deltaCompression=_interopRequireDefault(require("../snapshot-manager/SnapshotManager/deltaCompression.js")),_interpolateSnapshot=_interopRequireDefault(require("./lib/interpolateSnapshot.js")),_messageSchema=_interopRequireDefault(require("../server/messageSchema.js"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _regeneratorRuntime(){_regeneratorRuntime=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function c(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(t){c=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var i=e&&e.prototype instanceof g?e:g,a=Object.create(i.prototype),s=new I(r||[]);return o(a,"_invoke",{value:E(t,n,s)}),a}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",p="suspendedYield",d="executing",y="completed",m={};function g(){}function v(){}function b(){}var w={};c(w,a,function(){return this});var S=Object.getPrototypeOf,_=S&&S(S(M([])));_&&_!==n&&r.call(_,a)&&(w=_);var k=b.prototype=g.prototype=Object.create(w);function x(t){["next","throw","return"].forEach(function(e){c(t,e,function(t){return this._invoke(e,t)})})}function P(t,e){function n(o,i,a,s){var u=h(t[o],t,i);if("throw"!==u.type){var c=u.arg,l=c.value;return l&&"object"==_typeof(l)&&r.call(l,"__await")?e.resolve(l.__await).then(function(t){n("next",t,a,s)},function(t){n("throw",t,a,s)}):e.resolve(l).then(function(t){c.value=t,a(c)},function(t){return n("throw",t,a,s)})}s(u.arg)}var i;o(this,"_invoke",{value:function(t,r){function o(){return new e(function(e,o){n(t,r,e,o)})}return i=i?i.then(o,o):o()}})}function E(e,n,r){var o=f;return function(i,a){if(o===d)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var u=C(s,r);if(u){if(u===m)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===f)throw o=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=d;var c=h(e,n,r);if("normal"===c.type){if(o=r.done?y:p,c.arg===m)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=y,r.method="throw",r.arg=c.arg)}}}function C(e,n){var r=n.method,o=e.iterator[r];if(o===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,C(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var i=h(o,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,m;var a=i.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function L(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function O(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function I(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(L,this),this.reset(!0)}function M(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function n(){for(;++o<e.length;)if(r.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return i.next=i}}throw new TypeError(_typeof(e)+" is not iterable")}return v.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:v,configurable:!0}),v.displayName=c(b,u,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===v||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,c(t,u,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},x(P.prototype),c(P.prototype,s,function(){return this}),e.AsyncIterator=P,e.async=function(t,n,r,o,i){void 0===i&&(i=Promise);var a=new P(l(t,n,r,o),i);return e.isGeneratorFunction(n)?a:a.next().then(function(t){return t.done?t.value:a.next()})},x(k),c(k,u,"Generator"),c(k,a,function(){return this}),c(k,"toString",function(){return"[object Generator]"}),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=M,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(r,o){return s.type="throw",s.arg=e,n.next=r,o&&(n.method="next",n.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,m):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),O(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;O(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:M(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function asyncGeneratorStep(t,e,n,r,o,i,a){try{var s=t[i](a),u=s.value}catch(t){return void n(t)}s.done?e(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(t){return function(){var e=this,n=arguments;return new Promise(function(r,o){var i=t.apply(e,n);function a(t){asyncGeneratorStep(i,r,o,a,s,"next",t)}function s(t){asyncGeneratorStep(i,r,o,a,s,"throw",t)}a(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,_toPropertyKey(r.key),r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _defineProperty(t,e,n){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!==_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}var encoder=new TextEncoder,config={},WebSocketClient=exports.default=function(){function t(e){var n=e.protobuf,r=void 0!==n&&n,o=e.msgpack,i=void 0!==o&&o,a=e.deltaCompression,s=void 0!==a&&a;_classCallCheck(this,t),this.id=t.id,this.config={protobuf:r,msgpack:i,deltaCompression:s},console.log("WebSocketClient is using ClientConfig",this.config),this.listeners={},this.connected=!1,this.pingIntervalId=null,this.rtt=void 0,this.rttMeasurements=[],this.snapshotSizeMeasurements=[],this.totalSnapshotSize=0,this.snapshotCount=0,this.reportFrequency=10}return _createClass(t,[{key:"init",value:function(t){this.game=t,this.hzMS=t.config.hzMS||16.666,this.game.systemsManager.addSystem("websocketClient",this)}},{key:"wsConnectionStringFromWindow",value:function(){var t=window.location.hostname,e=window.location.port;7777==e&&(e=8888);var n=window.location.protocol;return"".concat("https:"===n?"wss":"ws","://").concat(t,":").concat(e,"/websocket")}},{key:"connect",value:function(t){void 0===t&&"undefined"!=typeof window&&(t=this.wsConnectionStringFromWindow()),console.log("connecting to",t);this.inputBuffer={},this.inputSequenceNumber=0,this.latestSnapshot=null,this.previousSnapshot=null,this.connected=!0,this.game.communicationClient=this,this.game.onlineGameLoopRunning=!0,this.socket=new WebSocket(t),this.socket.binaryType="arraybuffer",this.socket.onopen=this.handleOpen.bind(this),this.socket.onmessage=this.handleMessage.bind(this),this.socket.onclose=this.handleClose.bind(this),this.socket.onerror=this.handleError.bind(this),this.game.onlineGameLoop(this.game),this.game.emit("connected"),this.startRttMeasurement()}},{key:"startRttMeasurement",value:function(){var t=this;this.pingIntervalId=setInterval(function(){var e=Date.now();t.lastPingTime=Date.now(),t.socket.send(JSON.stringify({action:"PING"})),t.on("PONG",function(){var n=Date.now()-e;t.rttMeasurements.push(n),t.rttMeasurements.length>10&&t.rttMeasurements.shift(),t.rtt=t.rttMeasurements.reduce(function(t,e){return t+e},0)/t.rttMeasurements.length,t.game.emit("pingtime",t.rtt)})},1e3)}},{key:"stopRttMeasurement",value:function(){clearInterval(this.pingIntervalId)}},{key:"startTicking",value:function(){var t=this,e=Math.max(this.hzMS-(this.rtt||100)/2,1);setInterval(function(){var e=Date.now()+t.rtt,n=JSON.stringify({action:"GAMETICK",clientTickTime:e});t.socket.send(n)},e)}},{key:"disconnect",value:function(){this.socket.close(),this.game.onlineGameLoopRunning=!1,this.totalSnapshotSize=0,this.snapshotCount=0,this.snapshotSizeMeasurements=[]}},{key:"sendMessage",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.connected)if("player_input"===t){if(void 0===e.controls&&void 0!==e.mouse&&null==e.mouse.LEFT&&null==e.mouse.RIGHT&&null==e.mouse.MIDDLE)return;this.inputSequenceNumber++,this.inputBuffer[this.inputSequenceNumber]=e;this.game.getSystem("entity-input");var n=JSON.stringify(Object.assign({action:t,sequenceNumber:this.inputSequenceNumber},e));this.socket.send(n)}else{n=JSON.stringify(Object.assign({action:t},e));this.socket.send(n)}else console.error("not connected will not attempt to send message",t,e)}},{key:"handleOpen",value:function(t){console.log("WebSocket is connected:",t)}},{key:"handleMessage",value:function(){var t=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){var n,r,o,i,a,s,u,c,l,h;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this.game,r=e.data,this.trackSnapshotSize(r),"string"==typeof e.data&&(r=JSON.parse(e.data)),"ASSIGN_ID"!==r.action){t.next=8;break}return n.setPlayerId(r.playerId),this.playerId=r.playerId,t.abrupt("return");case 8:if("BECOME_TICKER"!==r.action){t.next=11;break}return this.startTicking(this.socket),t.abrupt("return");case 11:if("PONG"!==r.action){t.next=16;break}return o=Date.now(),this.rtt=o-this.lastPingTime,this.listeners.PONG&&this.listeners.PONG(this.rtt),t.abrupt("return");case 16:if(this.config.msgpack&&(r=(0,_msgpack.decode)(r)),this.config.protobuf&&(i=new Uint8Array(r),a=n.Message.decode(i),s=n.Message.toObject(a,{longs:String,enums:String,bytes:String}),r=s),this.config.deltaCompression&&(r=_deltaCompression.default.decompress("player1",r)),"GAMETICK"===r.action&&(this.game.previousSnapshot=this.game.latestSnapshot,this.game.latestSnapshot=r,n.snapshotQueue.push(r),this.isServerSideReconciliationEnabled&&void 0!==r.lastProcessedInput)){if((u=r.lastProcessedInput[this.playerId])<this.inputSequenceNumber)for(c=u+1;c<=this.inputSequenceNumber;c++)l=this.inputBuffer[c],this.game.getSystem("entity-input").handleInputs(this.game.currentPlayerId,{controls:l.controls,mouse:l.controls},c);for(h=0;h<=u;h++)delete this.inputBuffer[h]}case 20:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"handleClose",value:function(t){console.log("WebSocket is closed:",t),this.stopRttMeasurement()}},{key:"handleError",value:function(t){console.error("WebSocket error:",t)}},{key:"on",value:function(t,e){this.listeners[t]=e}},{key:"getInterpolatedSnapshot",value:function(t){return _interpolateSnapshot.default.call(this,t)}},{key:"trackSnapshotSize",value:function(t){"string"==typeof t&&(t=encoder.encode(t));var e=new Uint8Array(t).length;if(this.totalSnapshotSize+=e,this.snapshotCount++,this.snapshotSizeMeasurements.push(e),this.snapshotCount>0&&this.snapshotCount%this.reportFrequency==0){var n=this.totalSnapshotSize/this.snapshotCount;this.game.emit("snapshotsize",n)}}}]),t}();function decodeFromBlob(t){return _decodeFromBlob.apply(this,arguments)}function _decodeFromBlob(){return(_decodeFromBlob=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.stream){t.next=6;break}return t.next=3,(0,_msgpack.decodeAsync)(e.stream());case 3:return t.abrupt("return",t.sent);case 6:return t.t0=_msgpack.decode,t.next=9,e.arrayBuffer();case 9:return t.t1=t.sent,t.abrupt("return",(0,t.t0)(t.t1));case 11:case"end":return t.stop()}},t)}))).apply(this,arguments)}function blobToArrayBuffer(t){return new Promise(function(e,n){var r=new FileReader;r.onloadend=function(){return e(r.result)},r.onerror=n,r.readAsArrayBuffer(t)})}function decodeBlob(t){return _decodeBlob.apply(this,arguments)}function _decodeBlob(){return(_decodeBlob=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){var n,r;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,blobToArrayBuffer(e);case 2:return n=t.sent,r=new Uint8Array(n),t.abrupt("return",r);case 5:case"end":return t.stop()}},t)}))).apply(this,arguments)}_defineProperty(WebSocketClient,"id","websocket-client");

},{"../server/messageSchema.js":22,"../snapshot-manager/SnapshotManager/deltaCompression.js":23,"./lib/interpolateSnapshot.js":5,"@msgpack/msgpack":15}],4:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var defaultAssets={pixel:"/img/game/pixel.png","pixel-black":"/img/game/pixel-black.png",player:"/img/game/link-walk/sprite_0.png","tile-block":"/img/game/tiles/tile-block.png","tile-grass":"/img/game/tiles/tile-grass.png","tile-bush":"/img/game/tiles/tile-bush.png","tile-path-green":"/img/game/tiles/tile-path-green.png","tile-path-brown":"/img/game/tiles/tile-path-brown.png","tile-exit":"/img/game/tiles/tile-exit.png","tile-entrance":"/img/game/tiles/tile-entrance.png",demon:"/img/game/npc/demon.gif","warp-to-home":"/img/game/env/warp-to-mantra-home-256.png","ayyo-key":"/img/game/env/ayyo-key-medium.png",hexapod:"/img/game/npc/hexapod.png",blackMage:{type:"spritesheet",url:"/img/game/sheets/mage.png",frameTags:{mageLeft:{rate:100,frames:[{x:0,y:0},{x:-32,y:0},{x:-64,y:0}]},playerRight:{frames:[{x:0,y:-64},{x:-32,y:-64},{x:-64,y:-64}]},playerRightJump:{frames:[{x:0,y:-192}]},playerLeftWalk:{rate:16,frames:[{x:-96,y:0},{x:-128,y:0},{x:-160,y:0}]},playerRightWalk:{rate:16,frames:[{x:-96,y:-64},{x:-128,y:-64},{x:-160,y:-64}]},playerDownRight:{frames:[{x:-352,y:-64}]},playerDownLeft:{frames:[{x:-352,y:0}]},mageJump:{rate:100,frames:[{x:-192,y:0}]}}},loz_spritesheet:{type:"spritesheet",url:"/img/game/sheets/loz_spritesheet.png",frameTags:{ayyoKey:{frames:[{x:-640,y:-656}]},ayyoDoor:{frames:[{x:-656,y:-656}]},player:{rate:100,frames:[{x:-592,y:-16},{x:-640,y:-16},{x:-592,y:-16},{x:-640,y:-16},{x:-656,y:-16},{x:-640,y:-16},{x:-640,y:-16},{x:-608,y:-16}]},playerIdle:{frames:[{x:-16,y:-16},{x:-64,y:-16}]},playerUp:{frames:[{x:-304,y:-16},{x:-352,y:-16}]},playerDown:{frames:[{x:-16,y:-16},{x:-64,y:-16}]},playerLeft:{rate:100,frames:[{x:-208,y:-16},{x:-256,y:-16}]},playerRight:{frames:[{x:-112,y:-16},{x:-160,y:-16}]},playerShoot:{frames:[{x:-16,y:-352}]},playerDamage:{frames:[{x:-16,y:-592},{x:-64,y:-592},{x:-112,y:-592},{x:-160,y:-592},{x:-208,y:-592},{x:-256,y:-592},{x:-304,y:-592},{x:-352,y:-592},{x:-400,y:-592},{x:-448,y:-592},{x:-496,y:-592}]},playerRodDown:{frames:[{x:-496,y:-304}]},playerRodUp:{frames:[{x:-400,y:-352}]},playerRodLeft:{frames:[{x:-208,y:-352}]},playerRodRight:{frames:[{x:-16,y:-352}]},arrow:{frames:[{x:-16,y:-494}]},arrowA:{frames:[{x:0,y:-494}]},arrowB:{frames:[{x:-32,y:-494}]},arrowC:{frames:[{x:-48,y:-494}]},arrowD:{frames:[{x:0,y:-480}]},arrowE:{frames:[{x:-16,y:-480}]},arrowF:{frames:[{x:-32,y:-480}]},arrowG:{frames:[{x:-48,y:-480}]},arrowH:{frames:[{x:-160,y:-496}]},arrowI:{frames:[{x:-16,y:-494}]},iceArrow:{frames:[{x:-160,y:-496}]},boomerang:{rate:4,frames:[{x:-304,y:-496},{x:-320,y:-496},{x:-336,y:-496},{x:-352,y:-496},{x:-368,y:-496},{x:-384,y:-496}]},bomb:{frames:[{x:-16,y:-544},{x:-64,y:-544},{x:-112,y:-544},{x:-160,y:-544}]},lantern:{frames:[{x:-16,y:-512}]},fire:{frames:[{x:-208,y:-544},{x:-224,y:-544}]},sword:{frames:[{x:-448,y:-400},{x:-496,y:-400}]}},frameWidth:16,frameHeight:16}},_default=exports.default=defaultAssets;

},{}],5:[function(require,module,exports){
"use strict";function iterpolateSnapshot(t,o,i){if(1,!o||!i)return i;for(var n=[],r=function(){var t=i.state[e],r=o.state.find(function(o){return o.id===t.id});if(!r)return 1;var s={id:t.id,position:{x:0,y:0},rotation:0};r.position&&t.position&&(s.position.x=r.position.x+1*(t.position.x-r.position.x),s.position.y=r.position.y+1*(t.position.y-r.position.y)),void 0!==r.rotation&&void 0!==t.rotation&&(s.rotation=r.rotation+1*(t.rotation-r.rotation)),n.push(s)},e=0;e<i.state.length;e++)r();return{state:n}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _default=exports.default=iterpolateSnapshot;

},{}],6:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CachedKeyDecoder=void 0;const utf8_1=require("./utils/utf8"),DEFAULT_MAX_KEY_LENGTH=16,DEFAULT_MAX_LENGTH_PER_KEY=16;class CachedKeyDecoder{constructor(e=DEFAULT_MAX_KEY_LENGTH,t=DEFAULT_MAX_LENGTH_PER_KEY){this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(let e=0;e<this.maxKeyLength;e++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,s){const h=this.caches[s-1];e:for(const r of h){const h=r.bytes;for(let r=0;r<s;r++)if(h[r]!==e[t+r])continue e;return r.str}return null}store(e,t){const s=this.caches[e.length-1],h={bytes:e,str:t};s.length>=this.maxLengthPerKey?s[Math.random()*s.length|0]=h:s.push(h)}decode(e,t,s){const h=this.find(e,t,s);if(null!=h)return this.hit++,h;this.miss++;const r=(0,utf8_1.utf8DecodeJs)(e,t,s),c=Uint8Array.prototype.slice.call(e,t,t+s);return this.store(c,r),r}}exports.CachedKeyDecoder=CachedKeyDecoder;

},{"./utils/utf8":21}],7:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DecodeError=void 0;class DecodeError extends Error{constructor(e){super(e);const r=Object.create(DecodeError.prototype);Object.setPrototypeOf(this,r),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:DecodeError.name})}}exports.DecodeError=DecodeError;

},{}],8:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Decoder=exports.DataViewIndexOutOfBoundsError=void 0;const prettyByte_1=require("./utils/prettyByte"),ExtensionCodec_1=require("./ExtensionCodec"),int_1=require("./utils/int"),utf8_1=require("./utils/utf8"),typedArrays_1=require("./utils/typedArrays"),CachedKeyDecoder_1=require("./CachedKeyDecoder"),DecodeError_1=require("./DecodeError"),STATE_ARRAY="array",STATE_MAP_KEY="map_key",STATE_MAP_VALUE="map_value",isValidMapKeyType=e=>"string"==typeof e||"number"==typeof e,HEAD_BYTE_REQUIRED=-1,EMPTY_VIEW=new DataView(new ArrayBuffer(0)),EMPTY_BYTES=new Uint8Array(EMPTY_VIEW.buffer);try{EMPTY_VIEW.getInt8(0)}catch(e){if(!(e instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}exports.DataViewIndexOutOfBoundsError=RangeError;const MORE_DATA=new exports.DataViewIndexOutOfBoundsError("Insufficient data"),sharedCachedKeyDecoder=new CachedKeyDecoder_1.CachedKeyDecoder;class Decoder{constructor(e){var t,i,s,r,o,n,h;this.totalPos=0,this.pos=0,this.view=EMPTY_VIEW,this.bytes=EMPTY_BYTES,this.headByte=HEAD_BYTE_REQUIRED,this.stack=[],this.extensionCodec=null!==(t=null==e?void 0:e.extensionCodec)&&void 0!==t?t:ExtensionCodec_1.ExtensionCodec.defaultCodec,this.context=null==e?void 0:e.context,this.useBigInt64=null!==(i=null==e?void 0:e.useBigInt64)&&void 0!==i&&i,this.maxStrLength=null!==(s=null==e?void 0:e.maxStrLength)&&void 0!==s?s:int_1.UINT32_MAX,this.maxBinLength=null!==(r=null==e?void 0:e.maxBinLength)&&void 0!==r?r:int_1.UINT32_MAX,this.maxArrayLength=null!==(o=null==e?void 0:e.maxArrayLength)&&void 0!==o?o:int_1.UINT32_MAX,this.maxMapLength=null!==(n=null==e?void 0:e.maxMapLength)&&void 0!==n?n:int_1.UINT32_MAX,this.maxExtLength=null!==(h=null==e?void 0:e.maxExtLength)&&void 0!==h?h:int_1.UINT32_MAX,this.keyDecoder=void 0!==(null==e?void 0:e.keyDecoder)?e.keyDecoder:sharedCachedKeyDecoder}reinitializeState(){this.totalPos=0,this.headByte=HEAD_BYTE_REQUIRED,this.stack.length=0}setBuffer(e){this.bytes=(0,typedArrays_1.ensureUint8Array)(e),this.view=(0,typedArrays_1.createDataView)(this.bytes),this.pos=0}appendBuffer(e){if(this.headByte!==HEAD_BYTE_REQUIRED||this.hasRemaining(1)){const t=this.bytes.subarray(this.pos),i=(0,typedArrays_1.ensureUint8Array)(e),s=new Uint8Array(t.length+i.length);s.set(t),s.set(i,t.length),this.setBuffer(s)}else this.setBuffer(e)}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){const{view:t,pos:i}=this;return new RangeError(`Extra ${t.byteLength-i} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){this.reinitializeState(),this.setBuffer(e);const t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}*decodeMulti(e){for(this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}async decodeAsync(e){let t,i=!1;for await(const s of e){if(i)throw this.createExtraByteError(this.totalPos);this.appendBuffer(s);try{t=this.doDecodeSync(),i=!0}catch(e){if(!(e instanceof exports.DataViewIndexOutOfBoundsError))throw e}this.totalPos+=this.pos}if(i){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return t}const{headByte:s,pos:r,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${(0,prettyByte_1.prettyByte)(s)} at ${o} (${r} in the current buffer)`)}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){let i=t,s=-1;for await(const r of e){if(t&&0===s)throw this.createExtraByteError(this.totalPos);this.appendBuffer(r),i&&(s=this.readArraySize(),i=!1,this.complete());try{for(;yield this.doDecodeSync(),0!=--s;);}catch(e){if(!(e instanceof exports.DataViewIndexOutOfBoundsError))throw e}this.totalPos+=this.pos}}doDecodeSync(){e:for(;;){const e=this.readHeadByte();let t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){const i=e-128;if(0!==i){this.pushMapState(i),this.complete();continue e}t={}}else if(e<160){const i=e-144;if(0!==i){this.pushArrayState(i),this.complete();continue e}t=[]}else{const i=e-160;t=this.decodeUtf8String(i,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===e){const e=this.lookU8();t=this.decodeUtf8String(e,1)}else if(218===e){const e=this.lookU16();t=this.decodeUtf8String(e,2)}else if(219===e){const e=this.lookU32();t=this.decodeUtf8String(e,4)}else if(220===e){const e=this.readU16();if(0!==e){this.pushArrayState(e),this.complete();continue e}t=[]}else if(221===e){const e=this.readU32();if(0!==e){this.pushArrayState(e),this.complete();continue e}t=[]}else if(222===e){const e=this.readU16();if(0!==e){this.pushMapState(e),this.complete();continue e}t={}}else if(223===e){const e=this.readU32();if(0!==e){this.pushMapState(e),this.complete();continue e}t={}}else if(196===e){const e=this.lookU8();t=this.decodeBinary(e,1)}else if(197===e){const e=this.lookU16();t=this.decodeBinary(e,2)}else if(198===e){const e=this.lookU32();t=this.decodeBinary(e,4)}else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e){const e=this.lookU8();t=this.decodeExtension(e,1)}else if(200===e){const e=this.lookU16();t=this.decodeExtension(e,2)}else{if(201!==e)throw new DecodeError_1.DecodeError(`Unrecognized type byte: ${(0,prettyByte_1.prettyByte)(e)}`);{const e=this.lookU32();t=this.decodeExtension(e,4)}}this.complete();const i=this.stack;for(;i.length>0;){const e=i[i.length-1];if(e.type===STATE_ARRAY){if(e.array[e.position]=t,e.position++,e.position!==e.size)continue e;i.pop(),t=e.array}else{if(e.type===STATE_MAP_KEY){if(!isValidMapKeyType(t))throw new DecodeError_1.DecodeError("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new DecodeError_1.DecodeError("The key __proto__ is not allowed");e.key=t,e.type=STATE_MAP_VALUE;continue e}if(e.map[e.key]=t,e.readCount++,e.readCount!==e.size){e.key=null,e.type=STATE_MAP_KEY;continue e}i.pop(),t=e.map}}return t}}readHeadByte(){return this.headByte===HEAD_BYTE_REQUIRED&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=HEAD_BYTE_REQUIRED}readArraySize(){const e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new DecodeError_1.DecodeError(`Unrecognized array type byte: ${(0,prettyByte_1.prettyByte)(e)}`)}}pushMapState(e){if(e>this.maxMapLength)throw new DecodeError_1.DecodeError(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.push({type:STATE_MAP_KEY,size:e,key:null,readCount:0,map:{}})}pushArrayState(e){if(e>this.maxArrayLength)throw new DecodeError_1.DecodeError(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.push({type:STATE_ARRAY,size:e,array:new Array(e),position:0})}decodeUtf8String(e,t){var i;if(e>this.maxStrLength)throw new DecodeError_1.DecodeError(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw MORE_DATA;const s=this.pos+t;let r;return r=this.stateIsMapKey()&&(null===(i=this.keyDecoder)||void 0===i?void 0:i.canBeCached(e))?this.keyDecoder.decode(this.bytes,s,e):(0,utf8_1.utf8Decode)(this.bytes,s,e),this.pos+=t+e,r}stateIsMapKey(){if(this.stack.length>0){return this.stack[this.stack.length-1].type===STATE_MAP_KEY}return!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new DecodeError_1.DecodeError(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw MORE_DATA;const i=this.pos+t,s=this.bytes.subarray(i,i+e);return this.pos+=t+e,s}decodeExtension(e,t){if(e>this.maxExtLength)throw new DecodeError_1.DecodeError(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);const i=this.view.getInt8(this.pos+t),s=this.decodeBinary(e,t+1);return this.extensionCodec.decode(s,i,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){const e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){const e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){const e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){const e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){const e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){const e=(0,int_1.getUint64)(this.view,this.pos);return this.pos+=8,e}readI64(){const e=(0,int_1.getInt64)(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){const e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){const e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){const e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){const e=this.view.getFloat64(this.pos);return this.pos+=8,e}}exports.Decoder=Decoder;

},{"./CachedKeyDecoder":6,"./DecodeError":7,"./ExtensionCodec":11,"./utils/int":17,"./utils/prettyByte":18,"./utils/typedArrays":20,"./utils/utf8":21}],9:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Encoder=exports.DEFAULT_INITIAL_BUFFER_SIZE=exports.DEFAULT_MAX_DEPTH=void 0;const utf8_1=require("./utils/utf8"),ExtensionCodec_1=require("./ExtensionCodec"),int_1=require("./utils/int"),typedArrays_1=require("./utils/typedArrays");exports.DEFAULT_MAX_DEPTH=100,exports.DEFAULT_INITIAL_BUFFER_SIZE=2048;class Encoder{constructor(e){var t,i,s,r,o,n,h,w;this.extensionCodec=null!==(t=null==e?void 0:e.extensionCodec)&&void 0!==t?t:ExtensionCodec_1.ExtensionCodec.defaultCodec,this.context=null==e?void 0:e.context,this.useBigInt64=null!==(i=null==e?void 0:e.useBigInt64)&&void 0!==i&&i,this.maxDepth=null!==(s=null==e?void 0:e.maxDepth)&&void 0!==s?s:exports.DEFAULT_MAX_DEPTH,this.initialBufferSize=null!==(r=null==e?void 0:e.initialBufferSize)&&void 0!==r?r:exports.DEFAULT_INITIAL_BUFFER_SIZE,this.sortKeys=null!==(o=null==e?void 0:e.sortKeys)&&void 0!==o&&o,this.forceFloat32=null!==(n=null==e?void 0:e.forceFloat32)&&void 0!==n&&n,this.ignoreUndefined=null!==(h=null==e?void 0:e.ignoreUndefined)&&void 0!==h&&h,this.forceIntegerToFloat=null!==(w=null==e?void 0:e.forceIntegerToFloat)&&void 0!==w&&w,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}reinitializeState(){this.pos=0}encodeSharedRef(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}encode(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.useBigInt64&&"bigint"==typeof e?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){const t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)}resizeBuffer(e){const t=new ArrayBuffer(e),i=new Uint8Array(t),s=new DataView(t);i.set(this.bytes),this.view=s,this.bytes=i}encodeNil(){this.writeU8(192)}encodeBoolean(e){!1===e?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error(`Too long string: ${e} bytes in UTF-8`);this.writeU8(219),this.writeU32(e)}}encodeString(e){const t=(0,utf8_1.utf8Count)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,utf8_1.utf8Encode)(e,this.bytes,this.pos),this.pos+=t}encodeObject(e,t){const i=this.extensionCodec.tryToEncode(e,this.context);if(null!=i)this.encodeExtension(i);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`);this.encodeMap(e,t)}}encodeBinary(e){const t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error(`Too large binary: ${t}`);this.writeU8(198),this.writeU32(t)}const i=(0,typedArrays_1.ensureUint8Array)(e);this.writeU8a(i)}encodeArray(e,t){const i=e.length;if(i<16)this.writeU8(144+i);else if(i<65536)this.writeU8(220),this.writeU16(i);else{if(!(i<4294967296))throw new Error(`Too large array: ${i}`);this.writeU8(221),this.writeU32(i)}for(const i of e)this.doEncode(i,t+1)}countWithoutUndefined(e,t){let i=0;for(const s of t)void 0!==e[s]&&i++;return i}encodeMap(e,t){const i=Object.keys(e);this.sortKeys&&i.sort();const s=this.ignoreUndefined?this.countWithoutUndefined(e,i):i.length;if(s<16)this.writeU8(128+s);else if(s<65536)this.writeU8(222),this.writeU16(s);else{if(!(s<4294967296))throw new Error(`Too large map object: ${s}`);this.writeU8(223),this.writeU32(s)}for(const s of i){const i=e[s];this.ignoreUndefined&&void 0===i||(this.encodeString(s),this.doEncode(i,t+1))}}encodeExtension(e){const t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error(`Too large extension object: ${t}`);this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){const t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),(0,int_1.setUint64)(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),(0,int_1.setInt64)(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}}exports.Encoder=Encoder;

},{"./ExtensionCodec":11,"./utils/int":17,"./utils/typedArrays":20,"./utils/utf8":21}],10:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExtData=void 0;class ExtData{constructor(t,a){this.type=t,this.data=a}}exports.ExtData=ExtData;

},{}],11:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExtensionCodec=void 0;const ExtData_1=require("./ExtData"),timestamp_1=require("./timestamp");class ExtensionCodec{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(timestamp_1.timestampExtension)}register({type:t,encode:e,decode:s}){if(t>=0)this.encoders[t]=e,this.decoders[t]=s;else{const n=1+t;this.builtInEncoders[n]=e,this.builtInDecoders[n]=s}}tryToEncode(t,e){for(let s=0;s<this.builtInEncoders.length;s++){const n=this.builtInEncoders[s];if(null!=n){const o=n(t,e);if(null!=o){const t=-1-s;return new ExtData_1.ExtData(t,o)}}}for(let s=0;s<this.encoders.length;s++){const n=this.encoders[s];if(null!=n){const o=n(t,e);if(null!=o){const t=s;return new ExtData_1.ExtData(t,o)}}}return t instanceof ExtData_1.ExtData?t:null}decode(t,e,s){const n=e<0?this.builtInDecoders[-1-e]:this.decoders[e];return n?n(t,e,s):new ExtData_1.ExtData(e,t)}}ExtensionCodec.defaultCodec=new ExtensionCodec,exports.ExtensionCodec=ExtensionCodec;

},{"./ExtData":10,"./timestamp":16}],12:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeMulti=exports.decode=exports.defaultDecodeOptions=void 0;const Decoder_1=require("./Decoder");function decode(e,d){return new Decoder_1.Decoder(d).decode(e)}function decodeMulti(e,d){return new Decoder_1.Decoder(d).decodeMulti(e)}exports.defaultDecodeOptions=void 0,exports.decode=decode,exports.decodeMulti=decodeMulti;

},{"./Decoder":8}],13:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeStream=exports.decodeMultiStream=exports.decodeArrayStream=exports.decodeAsync=void 0;const Decoder_1=require("./Decoder"),stream_1=require("./utils/stream");async function decodeAsync(e,r){const t=(0,stream_1.ensureAsyncIterable)(e);return new Decoder_1.Decoder(r).decodeAsync(t)}function decodeArrayStream(e,r){const t=(0,stream_1.ensureAsyncIterable)(e);return new Decoder_1.Decoder(r).decodeArrayStream(t)}function decodeMultiStream(e,r){const t=(0,stream_1.ensureAsyncIterable)(e);return new Decoder_1.Decoder(r).decodeStream(t)}exports.decodeAsync=decodeAsync,exports.decodeArrayStream=decodeArrayStream,exports.decodeMultiStream=decodeMultiStream,exports.decodeStream=void 0;

},{"./Decoder":8,"./utils/stream":19}],14:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.encode=exports.defaultEncodeOptions=void 0;const Encoder_1=require("./Encoder");function encode(e,o){return new Encoder_1.Encoder(o).encodeSharedRef(e)}exports.defaultEncodeOptions=void 0,exports.encode=encode;

},{"./Encoder":9}],15:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.decodeTimestampExtension=exports.encodeTimestampExtension=exports.decodeTimestampToTimeSpec=exports.encodeTimeSpecToTimestamp=exports.encodeDateToTimeSpec=exports.EXT_TIMESTAMP=exports.ExtData=exports.ExtensionCodec=exports.Encoder=exports.DecodeError=exports.DataViewIndexOutOfBoundsError=exports.Decoder=exports.decodeStream=exports.decodeMultiStream=exports.decodeArrayStream=exports.decodeAsync=exports.decodeMulti=exports.decode=exports.encode=void 0;const encode_1=require("./encode");Object.defineProperty(exports,"encode",{enumerable:!0,get:function(){return encode_1.encode}});const decode_1=require("./decode");Object.defineProperty(exports,"decode",{enumerable:!0,get:function(){return decode_1.decode}}),Object.defineProperty(exports,"decodeMulti",{enumerable:!0,get:function(){return decode_1.decodeMulti}});const decodeAsync_1=require("./decodeAsync");Object.defineProperty(exports,"decodeAsync",{enumerable:!0,get:function(){return decodeAsync_1.decodeAsync}}),Object.defineProperty(exports,"decodeArrayStream",{enumerable:!0,get:function(){return decodeAsync_1.decodeArrayStream}}),Object.defineProperty(exports,"decodeMultiStream",{enumerable:!0,get:function(){return decodeAsync_1.decodeMultiStream}}),Object.defineProperty(exports,"decodeStream",{enumerable:!0,get:function(){return decodeAsync_1.decodeStream}});const Decoder_1=require("./Decoder");Object.defineProperty(exports,"Decoder",{enumerable:!0,get:function(){return Decoder_1.Decoder}}),Object.defineProperty(exports,"DataViewIndexOutOfBoundsError",{enumerable:!0,get:function(){return Decoder_1.DataViewIndexOutOfBoundsError}});const DecodeError_1=require("./DecodeError");Object.defineProperty(exports,"DecodeError",{enumerable:!0,get:function(){return DecodeError_1.DecodeError}});const Encoder_1=require("./Encoder");Object.defineProperty(exports,"Encoder",{enumerable:!0,get:function(){return Encoder_1.Encoder}});const ExtensionCodec_1=require("./ExtensionCodec");Object.defineProperty(exports,"ExtensionCodec",{enumerable:!0,get:function(){return ExtensionCodec_1.ExtensionCodec}});const ExtData_1=require("./ExtData");Object.defineProperty(exports,"ExtData",{enumerable:!0,get:function(){return ExtData_1.ExtData}});const timestamp_1=require("./timestamp");Object.defineProperty(exports,"EXT_TIMESTAMP",{enumerable:!0,get:function(){return timestamp_1.EXT_TIMESTAMP}}),Object.defineProperty(exports,"encodeDateToTimeSpec",{enumerable:!0,get:function(){return timestamp_1.encodeDateToTimeSpec}}),Object.defineProperty(exports,"encodeTimeSpecToTimestamp",{enumerable:!0,get:function(){return timestamp_1.encodeTimeSpecToTimestamp}}),Object.defineProperty(exports,"decodeTimestampToTimeSpec",{enumerable:!0,get:function(){return timestamp_1.decodeTimestampToTimeSpec}}),Object.defineProperty(exports,"encodeTimestampExtension",{enumerable:!0,get:function(){return timestamp_1.encodeTimestampExtension}}),Object.defineProperty(exports,"decodeTimestampExtension",{enumerable:!0,get:function(){return timestamp_1.decodeTimestampExtension}});

},{"./DecodeError":7,"./Decoder":8,"./Encoder":9,"./ExtData":10,"./ExtensionCodec":11,"./decode":12,"./decodeAsync":13,"./encode":14,"./timestamp":16}],16:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.timestampExtension=exports.decodeTimestampExtension=exports.decodeTimestampToTimeSpec=exports.encodeTimestampExtension=exports.encodeDateToTimeSpec=exports.encodeTimeSpecToTimestamp=exports.EXT_TIMESTAMP=void 0;const DecodeError_1=require("./DecodeError"),int_1=require("./utils/int");exports.EXT_TIMESTAMP=-1;const TIMESTAMP32_MAX_SEC=4294967295,TIMESTAMP64_MAX_SEC=17179869183;function encodeTimeSpecToTimestamp({sec:e,nsec:t}){if(e>=0&&t>=0&&e<=TIMESTAMP64_MAX_SEC){if(0===t&&e<=TIMESTAMP32_MAX_SEC){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e),t}{const n=e/4294967296,o=4294967295&e,i=new Uint8Array(8),s=new DataView(i.buffer);return s.setUint32(0,t<<2|3&n),s.setUint32(4,o),i}}{const n=new Uint8Array(12),o=new DataView(n.buffer);return o.setUint32(0,t),(0,int_1.setInt64)(o,4,e),n}}function encodeDateToTimeSpec(e){const t=e.getTime(),n=Math.floor(t/1e3),o=1e6*(t-1e3*n),i=Math.floor(o/1e9);return{sec:n+i,nsec:o-1e9*i}}function encodeTimestampExtension(e){if(e instanceof Date){return encodeTimeSpecToTimestamp(encodeDateToTimeSpec(e))}return null}function decodeTimestampToTimeSpec(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:{const e=t.getUint32(0);return{sec:4294967296*(3&e)+t.getUint32(4),nsec:e>>>2}}case 12:return{sec:(0,int_1.getInt64)(t,4),nsec:t.getUint32(0)};default:throw new DecodeError_1.DecodeError(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${e.length}`)}}function decodeTimestampExtension(e){const t=decodeTimestampToTimeSpec(e);return new Date(1e3*t.sec+t.nsec/1e6)}exports.encodeTimeSpecToTimestamp=encodeTimeSpecToTimestamp,exports.encodeDateToTimeSpec=encodeDateToTimeSpec,exports.encodeTimestampExtension=encodeTimestampExtension,exports.decodeTimestampToTimeSpec=decodeTimestampToTimeSpec,exports.decodeTimestampExtension=decodeTimestampExtension,exports.timestampExtension={type:exports.EXT_TIMESTAMP,encode:encodeTimestampExtension,decode:decodeTimestampExtension};

},{"./DecodeError":7,"./utils/int":17}],17:[function(require,module,exports){
"use strict";function setUint64(t,e,n){const s=n/4294967296,i=n;t.setUint32(e,s),t.setUint32(e+4,i)}function setInt64(t,e,n){const s=Math.floor(n/4294967296),i=n;t.setUint32(e,s),t.setUint32(e+4,i)}function getInt64(t,e){return 4294967296*t.getInt32(e)+t.getUint32(e+4)}function getUint64(t,e){return 4294967296*t.getUint32(e)+t.getUint32(e+4)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getUint64=exports.getInt64=exports.setInt64=exports.setUint64=exports.UINT32_MAX=void 0,exports.UINT32_MAX=4294967295,exports.setUint64=setUint64,exports.setInt64=setInt64,exports.getInt64=getInt64,exports.getUint64=getUint64;

},{}],18:[function(require,module,exports){
"use strict";function prettyByte(t){return`${t<0?"-":""}0x${Math.abs(t).toString(16).padStart(2,"0")}`}Object.defineProperty(exports,"__esModule",{value:!0}),exports.prettyByte=void 0,exports.prettyByte=prettyByte;

},{}],19:[function(require,module,exports){
"use strict";function isAsyncIterable(e){return null!=e[Symbol.asyncIterator]}function assertNonNull(e){if(null==e)throw new Error("Assertion Failure: value must not be null nor undefined")}async function*asyncIterableFromStream(e){const r=e.getReader();try{for(;;){const{done:e,value:t}=await r.read();if(e)return;assertNonNull(t),yield t}}finally{r.releaseLock()}}function ensureAsyncIterable(e){return isAsyncIterable(e)?e:asyncIterableFromStream(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ensureAsyncIterable=exports.asyncIterableFromStream=exports.isAsyncIterable=void 0,exports.isAsyncIterable=isAsyncIterable,exports.asyncIterableFromStream=asyncIterableFromStream,exports.ensureAsyncIterable=ensureAsyncIterable;

},{}],20:[function(require,module,exports){
"use strict";function ensureUint8Array(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function createDataView(e){if(e instanceof ArrayBuffer)return new DataView(e);const r=ensureUint8Array(e);return new DataView(r.buffer,r.byteOffset,r.byteLength)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.createDataView=exports.ensureUint8Array=void 0,exports.ensureUint8Array=ensureUint8Array,exports.createDataView=createDataView;

},{}],21:[function(require,module,exports){
"use strict";function utf8Count(e){const t=e.length;let o=0,n=0;for(;n<t;){let c=e.charCodeAt(n++);if(0!=(4294967168&c))if(0==(4294965248&c))o+=2;else{if(c>=55296&&c<=56319&&n<t){const t=e.charCodeAt(n);56320==(64512&t)&&(++n,c=((1023&c)<<10)+(1023&t)+65536)}o+=0==(4294901760&c)?3:4}else o++}return o}function utf8EncodeJs(e,t,o){const n=e.length;let c=o,s=0;for(;s<n;){let o=e.charCodeAt(s++);if(0!=(4294967168&o)){if(0==(4294965248&o))t[c++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&s<n){const t=e.charCodeAt(s);56320==(64512&t)&&(++s,o=((1023&o)<<10)+(1023&t)+65536)}0==(4294901760&o)?(t[c++]=o>>12&15|224,t[c++]=o>>6&63|128):(t[c++]=o>>18&7|240,t[c++]=o>>12&63|128,t[c++]=o>>6&63|128)}t[c++]=63&o|128}else t[c++]=o}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.utf8Decode=exports.utf8DecodeTD=exports.utf8DecodeJs=exports.utf8Encode=exports.utf8EncodeTE=exports.utf8EncodeJs=exports.utf8Count=void 0,exports.utf8Count=utf8Count,exports.utf8EncodeJs=utf8EncodeJs;const sharedTextEncoder=new TextEncoder,TEXT_ENCODER_THRESHOLD=50;function utf8EncodeTE(e,t,o){sharedTextEncoder.encodeInto(e,t.subarray(o))}function utf8Encode(e,t,o){e.length>TEXT_ENCODER_THRESHOLD?utf8EncodeTE(e,t,o):utf8EncodeJs(e,t,o)}exports.utf8EncodeTE=utf8EncodeTE,exports.utf8Encode=utf8Encode;const CHUNK_SIZE=4096;function utf8DecodeJs(e,t,o){let n=t;const c=n+o,s=[];let u="";for(;n<c;){const t=e[n++];if(0==(128&t))s.push(t);else if(192==(224&t)){const o=63&e[n++];s.push((31&t)<<6|o)}else if(224==(240&t)){const o=63&e[n++],c=63&e[n++];s.push((31&t)<<12|o<<6|c)}else if(240==(248&t)){let o=(7&t)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++];o>65535&&(o-=65536,s.push(o>>>10&1023|55296),o=56320|1023&o),s.push(o)}else s.push(t);s.length>=CHUNK_SIZE&&(u+=String.fromCharCode(...s),s.length=0)}return s.length>0&&(u+=String.fromCharCode(...s)),u}exports.utf8DecodeJs=utf8DecodeJs;const sharedTextDecoder=new TextDecoder,TEXT_DECODER_THRESHOLD=200;function utf8DecodeTD(e,t,o){const n=e.subarray(t,t+o);return sharedTextDecoder.decode(n)}function utf8Decode(e,t,o){return o>TEXT_DECODER_THRESHOLD?utf8DecodeTD(e,t,o):utf8DecodeJs(e,t,o)}exports.utf8DecodeTD=utf8DecodeTD,exports.utf8Decode=utf8Decode;

},{}],22:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var actionTypes={gametick:0,assign_id:1,become_ticker:2,pong:3},entityTypes={PLAYER:0,BULLET:1,BLOCK:2,BORDER:3,BODY:4},playerSchema={id:{type:"UInt16"},name:{type:"UTF8String"},type:{type:"Enum",enum:entityTypes},position:{type:"Record",schema:{x:{type:"Int32"},y:{type:"Int32"}}},velocity:{type:"Record",schema:{x:{type:"Int32"},y:{type:"Int32"}}},width:{type:"Int32"},height:{type:"Int32"},rotation:{type:"Int32"},mass:{type:"Int32"},health:{type:"Int32"},depth:{type:"Float64"},lifetime:{type:"Int32"},radius:{type:"Float64"},isSensor:{type:"Boolean"},isStatic:{type:"Boolean"},destroyed:{type:"Boolean"},owner:{type:"UInt16"},maxSpeed:{type:"Int32"}},messageSchema={id:{type:"UInt16"},action:{type:"Enum",enum:actionTypes},state:{type:"Collection",schema:playerSchema},lastProcessedInput:{type:"UInt16"}},_default=exports.default=messageSchema;

},{}],23:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _float2Int=_interopRequireDefault(require("./float2Int.js"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,o)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _defineProperty(t,e,a){return(e=_toPropertyKey(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _toPropertyKey(t){var e=_toPrimitive(t,"string");return"symbol"===_typeof(e)?e:String(e)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var o=a.call(t,e||"default");if("object"!==_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}var DEFAULTS={position:{x:0,y:0},velocity:{x:0,y:0},rotation:0,width:0,height:0,mass:0,health:0,lifetime:0,maxSpeed:0},playerStateCache={},localPlayerStateCache={},deltaCompression={},config=deltaCompression.config={truncateFloats:!0,truncateToPrecision:3,floatProperties:["width","height","mass","health","lifetime","maxSpeed"],float2Int:!0};deltaCompression.resetState=function(t){playerStateCache[t]&&(playerStateCache[t].stateCache={},playerStateCache[t].accumulatedStateCache={}),localPlayerStateCache[t]&&(localPlayerStateCache[t].stateCache={},localPlayerStateCache[t].accumulatedStateCache={})},deltaCompression.removeState=function(t,e){playerStateCache[t]&&(delete playerStateCache[t].stateCache[e.toString()],delete playerStateCache[t].accumulatedStateCache[e.toString()]),localPlayerStateCache[t]&&(delete localPlayerStateCache[t].stateCache[e.toString()],delete localPlayerStateCache[t].accumulatedStateCache[e.toString()])},deltaCompression.compress=function(t,e){var a=null;return playerStateCache[t]||(playerStateCache[t]={stateCache:{},accumulatedStateCache:{}}),e&&e.state&&(a={id:e.id,state:[]},e.state.forEach(function(e){if(e.destroy)delete playerStateCache[t].stateCache[e.id];else{var o=playerStateCache[t].stateCache[e.id]||DEFAULTS,r=_objectSpread({},e);if(void 0!==r.position){var i=getPositionDelta(r.position,o.position);r.position={x:_float2Int.default.encode(i.x),y:_float2Int.default.encode(i.y)}}if(void 0!==r.velocity){var n=getPositionDelta(r.velocity,o.velocity);r.velocity={x:_float2Int.default.encode(n.x),y:_float2Int.default.encode(n.y)}}if(void 0!==r.rotation){var c=getRotationDelta(r.rotation,o.rotation);r.rotation=_float2Int.default.encode(c)}config.floatProperties.forEach(function(t){if(void 0!==r[t]){var e=getDelta(r[t],o[t]);r[t]=_float2Int.default.encode(e)}}),playerStateCache[t].stateCache[e.id]=_objectSpread({},e),a.state.push(r)}})),a},deltaCompression.decompress=function(t,e){if(localPlayerStateCache[t]||(localPlayerStateCache[t]={stateCache:{},accumulatedStateCache:{}}),e&&e.state){var a=[];e.state.forEach(function(e){var o=localPlayerStateCache[t].accumulatedStateCache[e.id];o||(o={id:e.id,velocity:{x:0,y:0},position:{x:0,y:0},rotation:0,width:0,height:0,mass:0,health:0,lifetime:0,maxSpeed:0}),Object.keys(e).forEach(function(t){if("position"===t&&e.position){var a=_float2Int.default.decode(e.position.x),r=_float2Int.default.decode(e.position.y);o.position.x+=a,o.position.y+=r}else if("velocity"===t&&e.velocity){var i=_float2Int.default.decode(e.velocity.x),n=_float2Int.default.decode(e.velocity.y);o.velocity.x+=i,o.velocity.y+=n}else if("rotation"===t&&void 0!==e.rotation){var c=_float2Int.default.decode(e.rotation);o.rotation+=c}else{var l;if(-1!==config.floatProperties.indexOf(t))l=_float2Int.default.decode(e[t]),o[t]+=l;else o[t]=e[t]}}),localPlayerStateCache[t].accumulatedStateCache[e.id]=o,a.push(o)}),e.state=a}return e};var truncateToPrecision=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:config.truncateToPrecision;return config.truncateFloats?Number(t.toFixed(e)):t},getPositionDelta=function(t,e){if(void 0===e)return{x:0,y:0};var a=t.x-e.x,o=t.y-e.y;return{x:truncateToPrecision(a),y:truncateToPrecision(o)}},getRotationDelta=function(t,e){return void 0===e?0:truncateToPrecision(t-e)},getDelta=function(t,e){return void 0===e?t:truncateToPrecision(t-e)};function initializeDefaultState(t){var e={id:t};return config.floatProperties.forEach(function(t){e[t]=0}),e}var _default=exports.default=deltaCompression;

},{"./float2Int.js":24}],24:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var float2Int={encode:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return null==t?null:0===t?0:Math.round(t*Math.pow(10,e))},decode:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return this.truncateToPrecision(t/1e3,e)},truncateToPrecision:function(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}},_default=exports.default=float2Int;

},{}]},{},[1])(1)
});
